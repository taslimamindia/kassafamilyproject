name: Deploy Backend to Lightsail (Local Mode)

on:
  pull_request:
    branches:
      - main
    types: [closed]
    paths:
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy:
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy and Configure Env
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_SSH_HOST }}
          username: ${{ secrets.BACKEND_SSH_USER }}
          key: ${{ secrets.BACKEND_SSH_PRIVATE_KEY }}
          port: 22
          # Liste des variables à transmettre du runner GitHub vers l'instance SSH
          envs: >-
            BACKEND_ENV,
            BACKEND_LOCAL_DB_HOST,
            BACKEND_LOCAL_DB_USER,
            BACKEND_LOCAL_DB_PASS,
            BACKEND_LOCAL_DB_NAME,
            BACKEND_LOCAL_DB_PORT,
            BACKEND_JWT_SECRET,
            BACKEND_JWT_ALGORITHM,
            BACKEND_JWT_EXP_MINUTES,
            BACKEND_PUBLIC_PATHS,
            BACKEND_USER_PASSWORD_DEFAULT,
            BACKEND_AWS_S3_BUCKET,
            BACKEND_AWS_REGION,
            BACKEND_AWS_ACCESS_KEY_ID,
            BACKEND_AWS_SECRET_ACCESS_KEY
          script: |
            # 1. Variables de chemins
            TARGET_DIR="/home/ubuntu/kassa/api_famille_kassatech_org"
            ROOT_DIR="/home/ubuntu/kassa"

            # 2. Correction des permissions et sécurité Git
            # On s'assure que l'utilisateur 'ubuntu' est propriétaire de tout le projet
            sudo chown -R ubuntu:ubuntu $ROOT_DIR
            # On autorise Git à travailler dans ce dossier (évite l'erreur 'dubious ownership')
            git config --global --add safe.directory $TARGET_DIR

            # 3. Initialisation ou Mise à jour du code source
            if [ ! -d "$TARGET_DIR/.git" ]; then
              echo "Dossier .git absent. Clonage du dépôt..."
              mkdir -p $TARGET_DIR
              git clone https://github.com/${{ github.repository }}.git $TARGET_DIR
            fi

            cd $TARGET_DIR
            echo "Mise à jour du code (reset hard)..."
            git fetch origin main
            git reset --hard origin/main

            # 4. Création du fichier .env
            echo "Génération du fichier .env..."
            cat <<EOF > .env
            BACKEND_ENV=$BACKEND_ENV
            BACKEND_LOCAL_DB_HOST=$BACKEND_LOCAL_DB_HOST
            BACKEND_LOCAL_DB_USER=$BACKEND_LOCAL_DB_USER
            BACKEND_LOCAL_DB_PASS=$BACKEND_LOCAL_DB_PASS
            BACKEND_LOCAL_DB_NAME=$BACKEND_LOCAL_DB_NAME
            BACKEND_LOCAL_DB_PORT=$BACKEND_LOCAL_DB_PORT
            BACKEND_JWT_SECRET=$BACKEND_JWT_SECRET
            BACKEND_JWT_ALGORITHM=$BACKEND_JWT_ALGORITHM
            BACKEND_JWT_EXP_MINUTES=$BACKEND_JWT_EXP_MINUTES
            BACKEND_PUBLIC_PATHS=$BACKEND_PUBLIC_PATHS
            BACKEND_USER_PASSWORD_DEFAULT=$BACKEND_USER_PASSWORD_DEFAULT
            BACKEND_AWS_S3_BUCKET=$BACKEND_AWS_S3_BUCKET
            BACKEND_AWS_REGION=$BACKEND_AWS_REGION
            BACKEND_AWS_ACCESS_KEY_ID=$BACKEND_AWS_ACCESS_KEY_ID
            BACKEND_AWS_SECRET_ACCESS_KEY=$BACKEND_AWS_SECRET_ACCESS_KEY
            EOF

            # 5. Mise à jour des dépendances Python
            cd $ROOT_DIR
            if [ -f "venv/bin/activate" ]; then
              source venv/bin/activate
              pip install -r requirements.txt
            else
              echo "ERREUR : Environnement virtuel introuvable dans $ROOT_DIR/venv"
              exit 1
            fi

            # 6. Redémarrage du service systemd
            echo "Redémarrage du service FastAPI..."
            sudo systemctl restart fastapi_famille_kassa.service

            # 7. Vérification finale
            echo "Statut du service :"
            sudo systemctl status fastapi_famille_kassa.service --no-pager
            echo "Déploiement terminé avec succès."

        # Mapping entre Secrets GitHub et Variables d'environnement
        env:
          BACKEND_ENV: "local"
          BACKEND_LOCAL_DB_HOST: ${{ secrets.BACKEND_ONLINE_DB_HOST }}
          BACKEND_LOCAL_DB_USER: ${{ secrets.BACKEND_ONLINE_DB_USER }}
          BACKEND_LOCAL_DB_PASS: ${{ secrets.BACKEND_ONLINE_DB_PASS }}
          BACKEND_LOCAL_DB_NAME: ${{ secrets.BACKEND_ONLINE_DB_NAME }}
          BACKEND_LOCAL_DB_PORT: ${{ secrets.BACKEND_ONLINE_DB_PORT }}
          BACKEND_JWT_SECRET: ${{ secrets.JWT_SECRET }}
          BACKEND_JWT_ALGORITHM: "HS256"
          BACKEND_JWT_EXP_MINUTES: 1440
          BACKEND_PUBLIC_PATHS: "/login,/register,/docs"
          BACKEND_USER_PASSWORD_DEFAULT: ${{ secrets.USER_PWD_DEFAULT }}
          BACKEND_AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          BACKEND_AWS_REGION: ${{ secrets.AWS_REGION }}
          BACKEND_AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          BACKEND_AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
